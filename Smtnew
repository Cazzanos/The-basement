--[[
Fixed Mobile UI Library for Roblox Executors
Supports: Arceus X, Wave, Delta, Synapse X/Z, Potassium, and more
Features: PROPER Mobile Sizing, Fixed TextBox Error, Auto Config System

Fixed Issues:
- Mobile UI now properly sized and visible
- TextBox config indexing error fixed
- Better mobile responsiveness
]]

local Library = {}
getgenv().UI_CONFIG = getgenv().UI_CONFIG or {}

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local GuiService = game:GetService("GuiService")

-- Device Detection (Fixed)
local function isMobile()
    return UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
end

local function getScreenScale()
    local viewport = workspace.CurrentCamera.ViewportSize
    local isMobileDevice = isMobile()
    
    if isMobileDevice then
        -- Much larger mobile scaling
        return math.max(1.0, math.min(1.8, viewport.X / 400))
    else
        -- Desktop scaling
        return math.max(0.8, math.min(1.5, viewport.X / 1920))
    end
end

-- Responsive sizing (Fixed for Mobile)
local screenScale = getScreenScale()
local isMobileDevice = isMobile()

-- Fixed Theme Configuration (MUCH LARGER MOBILE SIZES)
local Theme = {
    -- Device info
    IsMobile = isMobileDevice,
    Scale = screenScale,
    
    -- FIXED: Much larger base sizes for mobile
    BaseSize = {
        Width = isMobileDevice and math.floor(450 * screenScale) or 700,
        Height = isMobileDevice and math.floor(550 * screenScale) or 500,
        NavWidth = isMobileDevice and math.floor(120 * screenScale) or 200,
        HeaderHeight = isMobileDevice and math.floor(55 * screenScale) or 60,
    },
    
    -- Modern Color Palette
    Colors = {
        Background = {
            Primary = Color3.fromRGB(15, 15, 23),
            Secondary = Color3.fromRGB(22, 22, 35),
            Tertiary = Color3.fromRGB(28, 28, 42),
            Glass = Color3.fromRGB(35, 35, 55),
        },
        
        Accent = {
            Primary = Color3.fromRGB(99, 102, 241),
            Secondary = Color3.fromRGB(139, 92, 246),
            Success = Color3.fromRGB(34, 197, 94),
            Warning = Color3.fromRGB(251, 191, 36),
            Error = Color3.fromRGB(239, 68, 68),
        },
        
        Text = {
            Primary = Color3.fromRGB(248, 250, 252),
            Secondary = Color3.fromRGB(203, 213, 225),
            Muted = Color3.fromRGB(148, 163, 184),
            Disabled = Color3.fromRGB(100, 116, 139),
        },
    },
    
    -- Typography (Mobile optimized)
    Fonts = {
        Primary = Enum.Font.GothamBold,
        Secondary = Enum.Font.Gotham,
        Mono = Enum.Font.RobotoMono,
    },
    
    -- FIXED: Larger text sizes for mobile
    TextSizes = {
        Title = isMobileDevice and 18 or 18,
        Subtitle = isMobileDevice and 14 or 14,
        Button = isMobileDevice and 16 or 16,
        Label = isMobileDevice and 15 or 15,
        Small = isMobileDevice and 13 or 13,
    },
    
    -- FIXED: Larger element sizes for mobile
    ElementSizes = {
        ButtonHeight = isMobileDevice and 50 or 45,
        ToggleHeight = isMobileDevice and 50 or 45,
        SectionHeight = isMobileDevice and 45 or 40,
        TabHeight = isMobileDevice and 50 or 45,
        IconSize = isMobileDevice and 22 or 20,
        ButtonSize = isMobileDevice and 35 or 35,
    },
    
    -- Animation Settings
    Animations = {
        Fast = TweenInfo.new(0.15, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        Medium = TweenInfo.new(0.25, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        Slow = TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        Bounce = TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
    },
    
    -- Responsive styling
    CornerRadius = UDim.new(0, isMobileDevice and 10 or 12),
    LargeCornerRadius = UDim.new(0, isMobileDevice and 12 or 16),
    SmallCornerRadius = UDim.new(0, isMobileDevice and 8 or 8),
    
    -- FIXED: Larger padding for mobile
    Padding = {
        Small = isMobileDevice and 10 or 8,
        Medium = isMobileDevice and 15 or 15,
        Large = isMobileDevice and 20 or 20,
    },
}

-- Auto-save system
local AutoSave = {}
function AutoSave:Save()
    if getgenv().SaveConfig then
        pcall(getgenv().SaveConfig)
    end
end

-- Utility Functions
local Utility = {}
local TweenCache = {}

function Utility:CreateCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = radius or Theme.CornerRadius
    corner.Parent = parent
    return corner
end

function Utility:CreateGradient(parent, colors, rotation)
    local gradient = Instance.new("UIGradient")
    gradient.Parent = parent
    gradient.Color = colors or ColorSequence.new{
        ColorSequenceKeypoint.new(0, Theme.Colors.Background.Glass),
        ColorSequenceKeypoint.new(1, Theme.Colors.Background.Tertiary)
    }
    gradient.Rotation = rotation or 45
    return gradient
end

function Utility:TweenObject(object, properties, tweenInfo, callback)
    if not object or not object.Parent then
        return
    end
    
    if TweenCache[object] then
        TweenCache[object]:Cancel()
        TweenCache[object] = nil
    end
    
    local info = tweenInfo or Theme.Animations.Medium
    local tween = TweenService:Create(object, info, properties)
    TweenCache[object] = tween
    
    local connection
    connection = tween.Completed:Connect(function()
        TweenCache[object] = nil
        if connection then
            connection:Disconnect()
        end
        if callback then
            callback()
        end
    end)
    
    tween:Play()
    return tween
end

function Utility:CreateRipple(button, color)
    if not button then return end
    
    button.ClipsDescendants = true
    
    local connection
    connection = button.MouseButton1Down:Connect(function()
        local ripple = Instance.new("Frame")
        ripple.Name = "Ripple"
        ripple.Parent = button
        ripple.BackgroundColor3 = color or Theme.Colors.Accent.Primary
        ripple.BackgroundTransparency = 0.8
        ripple.BorderSizePixel = 0
        ripple.AnchorPoint = Vector2.new(0.5, 0.5)
        
        Utility:CreateCorner(ripple, UDim.new(1, 0))
        
        local mouse = Players.LocalPlayer:GetMouse()
        local buttonPos = button.AbsolutePosition
        local buttonSize = button.AbsoluteSize
        local mousePos = Vector2.new(mouse.X, mouse.Y)
        local relativePos = mousePos - buttonPos
        
        ripple.Position = UDim2.new(0, relativePos.X, 0, relativePos.Y)
        ripple.Size = UDim2.new(0, 0, 0, 0)
        
        local maxSize = math.max(buttonSize.X, buttonSize.Y) * 2
        
        Utility:TweenObject(ripple, {
            Size = UDim2.new(0, maxSize, 0, maxSize),
            BackgroundTransparency = 1
        }, Theme.Animations.Medium, function()
            if ripple and ripple.Parent then
                ripple:Destroy()
            end
        end)
    end)
    
    return connection
end

-- Dragging System
function Library:DraggingEnabled(frame, parent)
    if not frame then return end
    
    parent = parent or frame
    local dragging = false
    local dragInput, mousePos, framePos

    local function startDrag(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            mousePos = input.Position
            framePos = parent.Position

            local endConnection
            endConnection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if endConnection then
                        endConnection:Disconnect()
                    end
                end
            end)
        end
    end

    local function updateDrag(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end

    frame.InputBegan:Connect(startDrag)
    frame.InputChanged:Connect(updateDrag)

    local dragConnection = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging and parent and parent.Parent then
            local delta = input.Position - mousePos
            parent.Position = UDim2.new(
                framePos.X.Scale, 
                framePos.X.Offset + delta.X, 
                framePos.Y.Scale, 
                framePos.Y.Offset + delta.Y
            )
        end
    end)
    
    return dragConnection
end

-- Library Management
local LibName = "ModernUI_"..tostring(math.random(1000, 9999))

function Library:ToggleUI()
    local ui = CoreGui:FindFirstChild(LibName)
    if ui then
        ui.Enabled = not ui.Enabled
    end
end

function Library:DestroyUI()
    local ui = CoreGui:FindFirstChild(LibName)
    if ui then
        local main = ui:FindFirstChild("Main")
        if main then
            Utility:TweenObject(main, {
                Size = UDim2.new(0, 0, 0, 0),
                BackgroundTransparency = 1
            }, Theme.Animations.Medium, function()
                ui:Destroy()
                for obj, tween in pairs(TweenCache) do
                    if tween then
                        tween:Cancel()
                    end
                end
                table.clear(TweenCache)
            end)
        else
            ui:Destroy()
        end
    end
end

-- Main Library Creation
function Library:Create(title)
    title = title or "Modern Executor"
    
    -- Calculate responsive sizes
    local mainWidth = Theme.BaseSize.Width
    local mainHeight = Theme.BaseSize.Height
    local navWidth = Theme.BaseSize.NavWidth
    local headerHeight = Theme.BaseSize.HeaderHeight
    
    -- Create main UI structure
    local UILibrary = Instance.new("ScreenGui")
    local Main = Instance.new("Frame")
    
    -- Glass morphism background
    local GlassBackground = Instance.new("Frame")
    
    -- Modern header
    local Header = Instance.new("Frame")
    local TitleLabel = Instance.new("TextLabel")
    local CloseButton = Instance.new("TextButton")
    local MinimizeButton = Instance.new("TextButton")
    
    -- Navigation sidebar
    local Navigation = Instance.new("Frame")
    local NavScrolling = Instance.new("ScrollingFrame")
    local NavLayout = Instance.new("UIListLayout")
    local NavPadding = Instance.new("UIPadding")
    
    -- Content area
    local ContentContainer = Instance.new("Frame")
    local TabsFolder = Instance.new("Folder")
    
    -- Setup main UI
    UILibrary.Name = LibName
    UILibrary.Parent = CoreGui
    UILibrary.ResetOnSpawn = false
    UILibrary.IgnoreGuiInset = true
    
    -- Main frame with LARGER responsive sizing
    Main.Name = "Main"
    Main.Parent = UILibrary
    Main.AnchorPoint = Vector2.new(0.5, 0.5)
    Main.BackgroundColor3 = Theme.Colors.Background.Primary
    Main.BackgroundTransparency = 0.15
    Main.Position = UDim2.new(0.5, 0, 0.5, 0)
    Main.Size = UDim2.new(0, 0, 0, 0)
    Main.BorderSizePixel = 0
    Main.ClipsDescendants = true
    
    Utility:CreateCorner(Main, Theme.LargeCornerRadius)
    
    -- Glass background effect
    GlassBackground.Name = "GlassBackground"
    GlassBackground.Parent = Main
    GlassBackground.Size = UDim2.new(1, 0, 1, 0)
    GlassBackground.BackgroundColor3 = Theme.Colors.Background.Glass
    GlassBackground.BackgroundTransparency = 0.3
    GlassBackground.BorderSizePixel = 0
    GlassBackground.ZIndex = 1
    
    Utility:CreateCorner(GlassBackground, Theme.LargeCornerRadius)
    Utility:CreateGradient(GlassBackground)
    
    -- Modern header
    Header.Name = "Header"
    Header.Parent = Main
    Header.BackgroundColor3 = Theme.Colors.Background.Secondary
    Header.BackgroundTransparency = 0.2
    Header.Size = UDim2.new(1, 0, 0, headerHeight)
    Header.BorderSizePixel = 0
    Header.ZIndex = 2
    
    Utility:CreateCorner(Header, Theme.LargeCornerRadius)
    Utility:CreateGradient(Header, ColorSequence.new{
        ColorSequenceKeypoint.new(0, Theme.Colors.Background.Secondary),
        ColorSequenceKeypoint.new(1, Theme.Colors.Background.Primary)
    })
    
    -- Header extension
    local HeaderExtension = Instance.new("Frame")
    HeaderExtension.Name = "Extension"
    HeaderExtension.Parent = Header
    HeaderExtension.AnchorPoint = Vector2.new(0, 1)
    HeaderExtension.BackgroundColor3 = Theme.Colors.Background.Secondary
    HeaderExtension.BackgroundTransparency = 0.2
    HeaderExtension.Position = UDim2.new(0, 0, 1, 0)
    HeaderExtension.Size = UDim2.new(1, 0, 0, 15)
    HeaderExtension.BorderSizePixel = 0
    HeaderExtension.ZIndex = 2
    
    -- Title
    TitleLabel.Name = "Title"
    TitleLabel.Parent = Header
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Position = UDim2.new(0, Theme.Padding.Medium, 0, 0)
    TitleLabel.Size = UDim2.new(0.6, 0, 1, 0)
    TitleLabel.Font = Theme.Fonts.Primary
    TitleLabel.Text = title
    TitleLabel.TextColor3 = Theme.Colors.Text.Primary
    TitleLabel.TextSize = Theme.TextSizes.Title
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.ZIndex = 3
    
    -- Modern close button
    CloseButton.Name = "Close"
    CloseButton.Parent = Header
    CloseButton.AnchorPoint = Vector2.new(1, 0.5)
    CloseButton.BackgroundColor3 = Theme.Colors.Accent.Error
    CloseButton.BackgroundTransparency = 0.8
    CloseButton.Position = UDim2.new(1, -Theme.Padding.Small, 0.5, 0)
    CloseButton.Size = UDim2.new(0, Theme.ElementSizes.ButtonSize, 0, Theme.ElementSizes.ButtonSize)
    CloseButton.Font = Theme.Fonts.Primary
    CloseButton.Text = "×"
    CloseButton.TextColor3 = Theme.Colors.Text.Primary
    CloseButton.TextSize = Theme.TextSizes.Button
    CloseButton.BorderSizePixel = 0
    CloseButton.ZIndex = 3
    
    Utility:CreateCorner(CloseButton, Theme.CornerRadius)
    Utility:CreateRipple(CloseButton, Theme.Colors.Accent.Error)
    
    -- Minimize button
    MinimizeButton.Name = "Minimize"
    MinimizeButton.Parent = Header
    MinimizeButton.AnchorPoint = Vector2.new(1, 0.5)
    MinimizeButton.BackgroundColor3 = Theme.Colors.Accent.Warning
    MinimizeButton.BackgroundTransparency = 0.8
    MinimizeButton.Position = UDim2.new(1, -Theme.ElementSizes.ButtonSize - Theme.Padding.Medium, 0.5, 0)
    MinimizeButton.Size = UDim2.new(0, Theme.ElementSizes.ButtonSize, 0, Theme.ElementSizes.ButtonSize)
    MinimizeButton.Font = Theme.Fonts.Primary
    MinimizeButton.Text = "−"
    MinimizeButton.TextColor3 = Theme.Colors.Text.Primary
    MinimizeButton.TextSize = Theme.TextSizes.Button - 2
    MinimizeButton.BorderSizePixel = 0
    MinimizeButton.ZIndex = 3
    
    Utility:CreateCorner(MinimizeButton, Theme.CornerRadius)
    Utility:CreateRipple(MinimizeButton, Theme.Colors.Accent.Warning)
    
    -- Navigation sidebar
    Navigation.Name = "Navigation"
    Navigation.Parent = Main
    Navigation.BackgroundColor3 = Theme.Colors.Background.Tertiary
    Navigation.BackgroundTransparency = 0.1
    Navigation.Position = UDim2.new(0, 0, 0, headerHeight)
    Navigation.Size = UDim2.new(0, navWidth, 1, -headerHeight)
    Navigation.BorderSizePixel = 0
    Navigation.ZIndex = 2
    
    Utility:CreateCorner(Navigation, Theme.CornerRadius)
    Utility:CreateGradient(Navigation)
    
    -- Navigation scrolling frame
    NavScrolling.Name = "NavScrolling"
    NavScrolling.Parent = Navigation
    NavScrolling.BackgroundTransparency = 1
    NavScrolling.Size = UDim2.new(1, 0, 1, 0)
    NavScrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
    NavScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
    NavScrolling.ScrollBarThickness = Theme.IsMobile and 4 or 4
    NavScrolling.ScrollBarImageColor3 = Theme.Colors.Accent.Primary
    NavScrolling.BorderSizePixel = 0
    NavScrolling.ZIndex = 3
    
    NavLayout.Parent = NavScrolling
    NavLayout.SortOrder = Enum.SortOrder.LayoutOrder
    NavLayout.Padding = UDim.new(0, 3)
    
    NavPadding.Parent = NavScrolling
    NavPadding.PaddingTop = UDim.new(0, Theme.Padding.Small)
    NavPadding.PaddingBottom = UDim.new(0, Theme.Padding.Small)
    NavPadding.PaddingLeft = UDim.new(0, Theme.Padding.Small)
    NavPadding.PaddingRight = UDim.new(0, Theme.Padding.Small)
    
    -- Content container
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Parent = Main
    ContentContainer.BackgroundColor3 = Theme.Colors.Background.Primary
    ContentContainer.BackgroundTransparency = 0.3
    ContentContainer.Position = UDim2.new(0, navWidth, 0, headerHeight)
    ContentContainer.Size = UDim2.new(1, -navWidth, 1, -headerHeight)
    ContentContainer.BorderSizePixel = 0
    ContentContainer.ZIndex = 2
    
    Utility:CreateCorner(ContentContainer, Theme.CornerRadius)
    
    TabsFolder.Name = "TabsFolder"
    TabsFolder.Parent = ContentContainer
    
    -- Enable dragging
    Library:DraggingEnabled(Header, Main)
    
    -- Button events
    CloseButton.MouseButton1Click:Connect(function()
        pcall(function()
            Utility:TweenObject(CloseButton, {
                BackgroundTransparency = 0.5
            }, Theme.Animations.Fast)
            
            task.wait(0.1)
            Library:DestroyUI()
        end)
    end)
    
    local minimized = false
    MinimizeButton.MouseButton1Click:Connect(function()
        pcall(function()
            minimized = not minimized
            
            Utility:TweenObject(MinimizeButton, {
                BackgroundTransparency = 0.5
            }, Theme.Animations.Fast)
            
            if minimized then
                Utility:TweenObject(Main, {
                    Size = UDim2.new(0, mainWidth, 0, headerHeight)
                }, Theme.Animations.Medium)
                MinimizeButton.Text = "+"
            else
                Utility:TweenObject(Main, {
                    Size = UDim2.new(0, mainWidth, 0, mainHeight)
                }, Theme.Animations.Medium)
                MinimizeButton.Text = "−"
            end
            
            task.wait(0.1)
            Utility:TweenObject(MinimizeButton, {
                BackgroundTransparency = 0.8
            }, Theme.Animations.Fast)
        end)
    end)
    
    -- Entrance animation
    Utility:TweenObject(Main, {
        Size = UDim2.new(0, mainWidth, 0, mainHeight)
    }, Theme.Animations.Bounce)
    
    -- Tab system
    local Tabs = {}
    local firstTab = true
    
    function Tabs:Tab(tabName, tabIcon)
        tabName = tabName or "Tab"
        tabIcon = tabIcon or "rbxassetid://7734053426"
        
        -- Create tab button
        local TabButton = Instance.new("TextButton")
        local TabIcon = Instance.new("ImageLabel")
        local TabGlow = Instance.new("Frame")
        
        -- Create tab content
        local TabContent = Instance.new("ScrollingFrame")
        local ContentLayout = Instance.new("UIListLayout")
        local ContentPadding = Instance.new("UIPadding")
        
        -- Tab button setup
        TabButton.Name = tabName.."_Button"
        TabButton.Parent = NavScrolling
        TabButton.BackgroundColor3 = Theme.Colors.Background.Glass
        TabButton.BackgroundTransparency = firstTab and 0.3 or 1
        TabButton.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.TabHeight)
        TabButton.Font = Theme.Fonts.Secondary
        TabButton.Text = Theme.IsMobile and "" or "  "..tabName
        TabButton.TextColor3 = firstTab and Theme.Colors.Text.Primary or Theme.Colors.Text.Secondary
        TabButton.TextSize = Theme.TextSizes.Label
        TabButton.TextXAlignment = Enum.TextXAlignment.Left
        TabButton.BorderSizePixel = 0
        TabButton.ZIndex = 4
        
        Utility:CreateCorner(TabButton, Theme.CornerRadius)
        
        -- Tab icon
        TabIcon.Name = "Icon"
        TabIcon.Parent = TabButton
        TabIcon.BackgroundTransparency = 1
        TabIcon.Position = UDim2.new(0.5, -Theme.ElementSizes.IconSize/2, 0.5, -Theme.ElementSizes.IconSize/2)
        TabIcon.Size = UDim2.new(0, Theme.ElementSizes.IconSize, 0, Theme.ElementSizes.IconSize)
        TabIcon.Image = tabIcon
        TabIcon.ImageColor3 = firstTab and Theme.Colors.Text.Primary or Theme.Colors.Text.Secondary
        TabIcon.ZIndex = 5
        
        if not Theme.IsMobile then
            TabIcon.Position = UDim2.new(0, Theme.Padding.Small, 0.5, -Theme.ElementSizes.IconSize/2)
        end
        
        -- Tab glow effect
        TabGlow.Name = "Glow"
        TabGlow.Parent = TabButton
        TabGlow.BackgroundColor3 = Theme.Colors.Accent.Primary
        TabGlow.BackgroundTransparency = firstTab and 0.8 or 1
        TabGlow.Size = UDim2.new(0, 4, 0.8, 0)
        TabGlow.Position = UDim2.new(0, 0, 0.1, 0)
        TabGlow.BorderSizePixel = 0
        TabGlow.ZIndex = 5
        
        Utility:CreateCorner(TabGlow, UDim.new(0, 2))
        
        -- Tab content setup
        TabContent.Name = tabName.."_Content"
        TabContent.Parent = TabsFolder
        TabContent.BackgroundTransparency = 1
        TabContent.Size = UDim2.new(1, 0, 1, 0)
        TabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
        TabContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
        TabContent.ScrollBarThickness = Theme.IsMobile and 5 or 6
        TabContent.ScrollBarImageColor3 = Theme.Colors.Accent.Primary
        TabContent.BorderSizePixel = 0
        TabContent.Visible = firstTab
        TabContent.ZIndex = 3
        
        ContentLayout.Parent = TabContent
        ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        ContentLayout.Padding = UDim.new(0, Theme.Padding.Small)
        
        ContentPadding.Parent = TabContent
        ContentPadding.PaddingTop = UDim.new(0, Theme.Padding.Medium)
        ContentPadding.PaddingBottom = UDim.new(0, Theme.Padding.Medium)
        ContentPadding.PaddingLeft = UDim.new(0, Theme.Padding.Medium)
        ContentPadding.PaddingRight = UDim.new(0, Theme.Padding.Medium)
        
        -- Add ripple effect
        Utility:CreateRipple(TabButton, Theme.Colors.Accent.Primary)
        
        -- Tab switching logic
        TabButton.MouseButton1Click:Connect(function()
            pcall(function()
                -- Hide all tabs
                for _, tab in pairs(TabsFolder:GetChildren()) do
                    if tab:IsA("ScrollingFrame") then
                        tab.Visible = false
                    end
                end
                
                -- Reset all tab buttons
                for _, button in pairs(NavScrolling:GetChildren()) do
                    if button:IsA("TextButton") and button.Name:find("_Button") then
                        Utility:TweenObject(button, {
                            BackgroundTransparency = 1,
                            TextColor3 = Theme.Colors.Text.Secondary
                        }, Theme.Animations.Fast)
                        
                        local icon = button:FindFirstChild("Icon")
                        if icon then
                            Utility:TweenObject(icon, {
                                ImageColor3 = Theme.Colors.Text.Secondary
                            }, Theme.Animations.Fast)
                        end
                        
                        local glow = button:FindFirstChild("Glow")
                        if glow then
                            Utility:TweenObject(glow, {
                                BackgroundTransparency = 1
                            }, Theme.Animations.Fast)
                        end
                    end
                end
                
                -- Activate current tab
                TabContent.Visible = true
                Utility:TweenObject(TabButton, {
                    BackgroundTransparency = 0.3,
                    TextColor3 = Theme.Colors.Text.Primary
                }, Theme.Animations.Fast)
                
                Utility:TweenObject(TabIcon, {
                    ImageColor3 = Theme.Colors.Text.Primary
                }, Theme.Animations.Fast)
                
                Utility:TweenObject(TabGlow, {
                    BackgroundTransparency = 0.8
                }, Theme.Animations.Fast)
            end)
        end)
        
        firstTab = false
        
        -- Elements for this tab (FIXED SYNTAX)
        local Elements = {}
        
        function Elements:Section(name)
            name = name or "Section"
            
            local Section = Instance.new("Frame")
            local SectionTitle = Instance.new("TextLabel")
            local SectionLine = Instance.new("Frame")
            
            Section.Name = name.."_Section"
            Section.Parent = TabContent
            Section.BackgroundColor3 = Theme.Colors.Background.Glass
            Section.BackgroundTransparency = 0.7
            Section.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.SectionHeight)
            Section.BorderSizePixel = 0
            Section.ZIndex = 4
            
            Utility:CreateCorner(Section, Theme.CornerRadius)
            
            SectionTitle.Name = "Title"
            SectionTitle.Parent = Section
            SectionTitle.BackgroundTransparency = 1
            SectionTitle.Position = UDim2.new(0, Theme.Padding.Medium, 0, 0)
            SectionTitle.Size = UDim2.new(1, -Theme.Padding.Medium * 2, 1, 0)
            SectionTitle.Font = Theme.Fonts.Primary
            SectionTitle.Text = name
            SectionTitle.TextColor3 = Theme.Colors.Text.Primary
            SectionTitle.TextSize = Theme.TextSizes.Label
            SectionTitle.TextXAlignment = Enum.TextXAlignment.Left
            SectionTitle.ZIndex = 5
            
            SectionLine.Name = "Line"
            SectionLine.Parent = Section
            SectionLine.BackgroundColor3 = Theme.Colors.Accent.Primary
            SectionLine.BackgroundTransparency = 0.5
            SectionLine.Position = UDim2.new(0, Theme.Padding.Medium, 1, -2)
            SectionLine.Size = UDim2.new(1, -Theme.Padding.Medium * 2, 0, 2)
            SectionLine.BorderSizePixel = 0
            SectionLine.ZIndex = 5
            
            Utility:CreateCorner(SectionLine, UDim.new(0, 1))
            
            return Section
        end
        
        function Elements:InfoLabel(text, textColor)
            text = text or "Info Label"
            textColor = textColor or Theme.Colors.Text.Secondary
            
            local InfoFrame = Instance.new("Frame")
            local InfoLabel = Instance.new("TextLabel")
            
            InfoFrame.Name = "InfoLabel"
            InfoFrame.Parent = TabContent
            InfoFrame.BackgroundTransparency = 1
            InfoFrame.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.SectionHeight - 5)
            InfoFrame.BorderSizePixel = 0
            InfoFrame.ZIndex = 4
            
            InfoLabel.Name = "Label"
            InfoLabel.Parent = InfoFrame
            InfoLabel.BackgroundTransparency = 1
            InfoLabel.Position = UDim2.new(0, Theme.Padding.Small, 0, 0)
            InfoLabel.Size = UDim2.new(1, -Theme.Padding.Small * 2, 1, 0)
            InfoLabel.Font = Theme.Fonts.Secondary
            InfoLabel.Text = text
            InfoLabel.TextColor3 = textColor
            InfoLabel.TextSize = Theme.TextSizes.Small
            InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
            InfoLabel.TextWrapped = true
            InfoLabel.ZIndex = 5
            
            return InfoFrame
        end
        
        function Elements:Button(text, callback)
            text = text or "Button"
            callback = callback or function() end
            
            local Button = Instance.new("TextButton")
            
            Button.Name = text.."_Button"
            Button.Parent = TabContent
            Button.BackgroundColor3 = Theme.Colors.Accent.Primary
            Button.BackgroundTransparency = 0.1
            Button.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ButtonHeight)
            Button.Font = Theme.Fonts.Secondary
            Button.Text = text
            Button.TextColor3 = Theme.Colors.Text.Primary
            Button.TextSize = Theme.TextSizes.Button
            Button.BorderSizePixel = 0
            Button.ZIndex = 4
            
            Utility:CreateCorner(Button, Theme.CornerRadius)
            Utility:CreateGradient(Button, ColorSequence.new{
                ColorSequenceKeypoint.new(0, Theme.Colors.Accent.Primary),
                ColorSequenceKeypoint.new(1, Theme.Colors.Accent.Secondary)
            })
            Utility:CreateRipple(Button, Theme.Colors.Text.Primary)
            
            Button.MouseEnter:Connect(function()
                Utility:TweenObject(Button, {
                    BackgroundTransparency = 0.05
                }, Theme.Animations.Fast)
            end)
            
            Button.MouseLeave:Connect(function()
                Utility:TweenObject(Button, {
                    BackgroundTransparency = 0.1
                }, Theme.Animations.Fast)
            end)
            
            Button.MouseButton1Click:Connect(function()
                pcall(function()
                    Utility:TweenObject(Button, {
                        Size = UDim2.new(1, -4, 0, Theme.ElementSizes.ButtonHeight - 4)
                    }, Theme.Animations.Fast)
                    
                    task.wait(0.1)
                    
                    Utility:TweenObject(Button, {
                        Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ButtonHeight)
                    }, Theme.Animations.Fast)
                    
                    callback()
                end)
            end)
            
            return Button
        end
        
        -- FIXED: Toggle with proper config handling
        function Elements:Toggle(name, config, callback)
            name = name or "Toggle"
            callback = callback or function() end
            
            -- FIXED: Handle both table and non-table config
            local configTable = config
            if type(config) ~= "table" then
                configTable = getgenv().UI_CONFIG
            end
            
            -- Initialize config value if it doesn't exist
            if configTable[name] == nil then
                configTable[name] = false
            end
            
            local toggled = configTable[name]
            
            local ToggleFrame = Instance.new("Frame")
            local ToggleLabel = Instance.new("TextLabel")
            local ToggleButton = Instance.new("TextButton")
            local ToggleIndicator = Instance.new("Frame")
            
            local switchWidth = Theme.IsMobile and 55 or 50
            local switchHeight = Theme.IsMobile and 30 or 28
            local indicatorSize = Theme.IsMobile and 22 or 20
            
            ToggleFrame.Name = name.."_Toggle"
            ToggleFrame.Parent = TabContent
            ToggleFrame.BackgroundColor3 = Theme.Colors.Background.Glass
            ToggleFrame.BackgroundTransparency = 0.7
            ToggleFrame.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
            ToggleFrame.BorderSizePixel = 0
            ToggleFrame.ZIndex = 4
            
            Utility:CreateCorner(ToggleFrame, Theme.CornerRadius)
            
            ToggleLabel.Name = "Label"
            ToggleLabel.Parent = ToggleFrame
            ToggleLabel.BackgroundTransparency = 1
            ToggleLabel.Position = UDim2.new(0, Theme.Padding.Medium, 0, 0)
            ToggleLabel.Size = UDim2.new(1, -switchWidth - Theme.Padding.Medium * 2, 1, 0)
            ToggleLabel.Font = Theme.Fonts.Secondary
            ToggleLabel.Text = name
            ToggleLabel.TextColor3 = Theme.Colors.Text.Primary
            ToggleLabel.TextSize = Theme.TextSizes.Label
            ToggleLabel.TextXAlignment = Enum.TextXAlignment.Left
            ToggleLabel.ZIndex = 5
            
            ToggleButton.Name = "Button"
            ToggleButton.Parent = ToggleFrame
            ToggleButton.AnchorPoint = Vector2.new(1, 0.5)
            ToggleButton.BackgroundColor3 = toggled and Theme.Colors.Accent.Primary or Theme.Colors.Background.Secondary
            ToggleButton.BackgroundTransparency = 0.2
            ToggleButton.Position = UDim2.new(1, -Theme.Padding.Medium, 0.5, 0)
            ToggleButton.Size = UDim2.new(0, switchWidth, 0, switchHeight)
            ToggleButton.Text = ""
            ToggleButton.BorderSizePixel = 0
            ToggleButton.ZIndex = 5
            
            Utility:CreateCorner(ToggleButton, UDim.new(0, switchHeight/2))
            
            ToggleIndicator.Name = "Indicator"
            ToggleIndicator.Parent = ToggleButton
            ToggleIndicator.BackgroundColor3 = Theme.Colors.Text.Primary
            ToggleIndicator.Position = UDim2.new(0, toggled and (switchWidth - indicatorSize - 4) or 4, 0.5, -indicatorSize/2)
            ToggleIndicator.Size = UDim2.new(0, indicatorSize, 0, indicatorSize)
            ToggleIndicator.BorderSizePixel = 0
            ToggleIndicator.ZIndex = 6
            
            Utility:CreateCorner(ToggleIndicator, UDim.new(0, indicatorSize/2))
            
            ToggleButton.MouseButton1Click:Connect(function()
                pcall(function()
                    toggled = not toggled
                    configTable[name] = toggled
                    
                    Utility:TweenObject(ToggleButton, {
                        BackgroundColor3 = toggled and Theme.Colors.Accent.Primary or Theme.Colors.Background.Secondary
                    }, Theme.Animations.Medium)
                    
                    Utility:TweenObject(ToggleIndicator, {
                        Position = UDim2.new(0, toggled and (switchWidth - indicatorSize - 4) or 4, 0.5, -indicatorSize/2)
                    }, Theme.Animations.Medium)
                    
                    AutoSave:Save()
                    callback(toggled)
                end)
            end)
            
            return ToggleFrame
        end
        
        -- FIXED: TextBox with proper config handling
        function Elements:TextBox(name, config, callback)
            name = name or "TextBox"
            callback = callback or function() end
            
            -- FIXED: Handle both table and non-table config
            local configTable = config
            if type(config) ~= "table" then
                configTable = getgenv().UI_CONFIG
            end
            
            -- Initialize config value if it doesn't exist
            if configTable[name] == nil then
                configTable[name] = ""
            end
            
            local TextBoxFrame = Instance.new("Frame")
            local TextBoxLabel = Instance.new("TextLabel")
            local TextBoxInput = Instance.new("TextBox")
            
            TextBoxFrame.Name = name.."_TextBox"
            TextBoxFrame.Parent = TabContent
            TextBoxFrame.BackgroundColor3 = Theme.Colors.Background.Glass
            TextBoxFrame.BackgroundTransparency = 0.7
            TextBoxFrame.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
            TextBoxFrame.BorderSizePixel = 0
            TextBoxFrame.ZIndex = 4
            
            Utility:CreateCorner(TextBoxFrame, Theme.CornerRadius)
            
            TextBoxLabel.Name = "Label"
            TextBoxLabel.Parent = TextBoxFrame
            TextBoxLabel.BackgroundTransparency = 1
            TextBoxLabel.Position = UDim2.new(0, Theme.Padding.Medium, 0, 0)
            TextBoxLabel.Size = UDim2.new(0.5, 0, 1, 0)
            TextBoxLabel.Font = Theme.Fonts.Secondary
            TextBoxLabel.Text = name
            TextBoxLabel.TextColor3 = Theme.Colors.Text.Primary
            TextBoxLabel.TextSize = Theme.TextSizes.Label
            TextBoxLabel.TextXAlignment = Enum.TextXAlignment.Left
            TextBoxLabel.ZIndex = 5
            
            TextBoxInput.Name = "Input"
            TextBoxInput.Parent = TextBoxFrame
            TextBoxInput.AnchorPoint = Vector2.new(1, 0.5)
            TextBoxInput.BackgroundColor3 = Theme.Colors.Background.Secondary
            TextBoxInput.BackgroundTransparency = 0.3
            TextBoxInput.Position = UDim2.new(1, -Theme.Padding.Medium, 0.5, 0)
            TextBoxInput.Size = UDim2.new(0.45, 0, 0, Theme.ElementSizes.ToggleHeight - 15)
            TextBoxInput.Font = Theme.Fonts.Secondary
            TextBoxInput.Text = tostring(configTable[name])
            TextBoxInput.TextColor3 = Theme.Colors.Text.Primary
            TextBoxInput.TextSize = Theme.TextSizes.Small
            TextBoxInput.BorderSizePixel = 0
            TextBoxInput.ZIndex = 5
            TextBoxInput.ClearTextOnFocus = false
            
            Utility:CreateCorner(TextBoxInput, Theme.SmallCornerRadius)
            
            TextBoxInput.FocusLost:Connect(function()
                pcall(function()
                    configTable[name] = TextBoxInput.Text
                    AutoSave:Save()
                    callback(TextBoxInput.Text)
                end)
            end)
            
            return TextBoxFrame
        end
        
        -- FIXED: Dropdown with proper config handling
        function Elements:Dropdown(name, options, config, callback)
            name = name or "Dropdown"
            options = options or {"Option 1", "Option 2", "Option 3"}
            callback = callback or function() end
            
            -- FIXED: Handle both table and non-table config
            local configTable = config
            if type(config) ~= "table" then
                configTable = getgenv().UI_CONFIG
            end
            
            -- Initialize config value if it doesn't exist
            if configTable[name] == nil then
                configTable[name] = options[1]
            end
            
            local DropdownFrame = Instance.new("Frame")
            local DropdownButton = Instance.new("TextButton")
            local DropdownLabel = Instance.new("TextLabel")
            local DropdownArrow = Instance.new("TextLabel")
            local DropdownList = Instance.new("Frame")
            local ListScrolling = Instance.new("ScrollingFrame")
            local ListLayout = Instance.new("UIListLayout")
            
            local isOpen = false
            local selectedOption = configTable[name]
            local optionHeight = Theme.IsMobile and 40 or 40
            
            DropdownFrame.Name = name.."_Dropdown"
            DropdownFrame.Parent = TabContent
            DropdownFrame.BackgroundColor3 = Theme.Colors.Background.Glass
            DropdownFrame.BackgroundTransparency = 0.7
            DropdownFrame.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
            DropdownFrame.BorderSizePixel = 0
            DropdownFrame.ZIndex = 4
            DropdownFrame.ClipsDescendants = true
            
            Utility:CreateCorner(DropdownFrame, Theme.CornerRadius)
            
            DropdownButton.Name = "Button"
            DropdownButton.Parent = DropdownFrame
            DropdownButton.BackgroundTransparency = 1
            DropdownButton.Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
            DropdownButton.Text = ""
            DropdownButton.ZIndex = 5
            
            DropdownLabel.Name = "Label"
            DropdownLabel.Parent = DropdownButton
            DropdownLabel.BackgroundTransparency = 1
            DropdownLabel.Position = UDim2.new(0, Theme.Padding.Medium, 0, 0)
            DropdownLabel.Size = UDim2.new(1, -50, 1, 0)
            DropdownLabel.Font = Theme.Fonts.Secondary
            DropdownLabel.Text = name .. ": " .. selectedOption
            DropdownLabel.TextColor3 = Theme.Colors.Text.Primary
            DropdownLabel.TextSize = Theme.TextSizes.Label
            DropdownLabel.TextXAlignment = Enum.TextXAlignment.Left
            DropdownLabel.ZIndex = 6
            
            DropdownArrow.Name = "Arrow"
            DropdownArrow.Parent = DropdownButton
            DropdownArrow.AnchorPoint = Vector2.new(1, 0.5)
            DropdownArrow.BackgroundTransparency = 1
            DropdownArrow.Position = UDim2.new(1, -Theme.Padding.Medium, 0.5, 0)
            DropdownArrow.Size = UDim2.new(0, 20, 0, 20)
            DropdownArrow.Font = Theme.Fonts.Secondary
            DropdownArrow.Text = "▼"
            DropdownArrow.TextColor3 = Theme.Colors.Text.Secondary
            DropdownArrow.TextSize = Theme.TextSizes.Small
            DropdownArrow.ZIndex = 6
            
            DropdownList.Name = "List"
            DropdownList.Parent = DropdownFrame
            DropdownList.BackgroundColor3 = Theme.Colors.Background.Secondary
            DropdownList.BackgroundTransparency = 0.1
            DropdownList.Position = UDim2.new(0, 0, 0, Theme.ElementSizes.ToggleHeight)
            DropdownList.Size = UDim2.new(1, 0, 0, 0)
            DropdownList.BorderSizePixel = 0
            DropdownList.ZIndex = 7
            
            Utility:CreateCorner(DropdownList, Theme.CornerRadius)
            
            ListScrolling.Name = "Scrolling"
            ListScrolling.Parent = DropdownList
            ListScrolling.BackgroundTransparency = 1
            ListScrolling.Size = UDim2.new(1, 0, 1, 0)
            ListScrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
            ListScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
            ListScrolling.ScrollBarThickness = Theme.IsMobile and 4 or 4
            ListScrolling.ScrollBarImageColor3 = Theme.Colors.Accent.Primary
            ListScrolling.BorderSizePixel = 0
            ListScrolling.ZIndex = 8
            
            ListLayout.Parent = ListScrolling
            ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
            ListLayout.Padding = UDim.new(0, 1)
            
            -- Create option buttons
            for i, option in ipairs(options) do
                local OptionButton = Instance.new("TextButton")
                
                OptionButton.Name = "Option_"..i
                OptionButton.Parent = ListScrolling
                OptionButton.BackgroundColor3 = Theme.Colors.Background.Tertiary
                OptionButton.BackgroundTransparency = 0.3
                OptionButton.Size = UDim2.new(1, 0, 0, optionHeight)
                OptionButton.Font = Theme.Fonts.Secondary
                OptionButton.Text = option
                OptionButton.TextColor3 = Theme.Colors.Text.Primary
                OptionButton.TextSize = Theme.TextSizes.Label - 1
                OptionButton.BorderSizePixel = 0
                OptionButton.ZIndex = 9
                
                Utility:CreateRipple(OptionButton, Theme.Colors.Accent.Primary)
                
                OptionButton.MouseEnter:Connect(function()
                    Utility:TweenObject(OptionButton, {
                        BackgroundTransparency = 0.1
                    }, Theme.Animations.Fast)
                end)
                
                OptionButton.MouseLeave:Connect(function()
                    Utility:TweenObject(OptionButton, {
                        BackgroundTransparency = 0.3
                    }, Theme.Animations.Fast)
                end)
                
                OptionButton.MouseButton1Click:Connect(function()
                    pcall(function()
                        selectedOption = option
                        configTable[name] = selectedOption
                        DropdownLabel.Text = name .. ": " .. selectedOption
                        
                        -- Close dropdown
                        isOpen = false
                        Utility:TweenObject(DropdownFrame, {
                            Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownList, {
                            Size = UDim2.new(1, 0, 0, 0)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownArrow, {
                            Rotation = 0
                        }, Theme.Animations.Medium)
                        
                        AutoSave:Save()
                        callback(selectedOption)
                    end)
                end)
            end
            
            DropdownButton.MouseButton1Click:Connect(function()
                pcall(function()
                    isOpen = not isOpen
                    
                    if isOpen then
                        local listHeight = math.min(#options * optionHeight, Theme.IsMobile and 150 or 150)
                        
                        Utility:TweenObject(DropdownFrame, {
                            Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight + listHeight)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownList, {
                            Size = UDim2.new(1, 0, 0, listHeight)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownArrow, {
                            Rotation = 180
                        }, Theme.Animations.Medium)
                    else
                        Utility:TweenObject(DropdownFrame, {
                            Size = UDim2.new(1, 0, 0, Theme.ElementSizes.ToggleHeight)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownList, {
                            Size = UDim2.new(1, 0, 0, 0)
                        }, Theme.Animations.Medium)
                        
                        Utility:TweenObject(DropdownArrow, {
                            Rotation = 0
                        }, Theme.Animations.Medium)
                    end
                end)
            end)
            
            return DropdownFrame
        end
        
        return Elements
    end
    
    return Tabs
end

return Library
